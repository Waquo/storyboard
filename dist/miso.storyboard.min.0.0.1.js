/**
* Miso.Storyboard - v0.0.1 - 10/31/2012
* http://github.com/misoproject/storyboard
* Copyright (c) 2012 Alex Graul, Irene Ros, Rich Harris;
* Dual Licensed: MIT, GPL
* https://github.com/misoproject/storyboard/blob/master/LICENSE-MIT 
*/
(function(a,_){var b=a.Miso=a.Miso||{};b.Events={publish:function(a){var b=_.toArray(arguments);b.shift(),this._events&&this._events[a]&&_.each(this._events[a],function(a){a.callback.apply(a.context||this,b)},this)},subscribe:function(a,b,c){c=c||{},this._events=this._events||{},this._events[a]=this._events[a]||[];var d={callback:b,priority:c.priority||0,token:c.token||_.uniqueId("t"),context:c.context||this},e;return _.each(this._events[a],function(a,b){if(!_.isUndefined(e))return;a.priority<=d.priority&&(e=b)}),this._events[a].splice(e,0,d),d.token},subscribeOnce:function(a,b){this._events=this._events||{};var c=_.uniqueId("t");return this.subscribe(a,function(){this.unsubscribe(a,{token:c}),b.apply(this,arguments)},this,c)},unsubscribe:function(a,b){if(_.isUndefined(this._events[a]))return this;_.isFunction(b)?this._events[a]=_.reject(this._events[a],function(a){return a.callback===b}):_.isString(b)?this._events[a]=_.reject(this._events[a],function(a){return a.token===b}):this._events[a]=[]}}})(this,_),function(a,_){function e(a,b,c){this._transitioning=!0;var d=this._complete=c||_.Deferred(),e=b?b:[],f=_.Deferred().done(_.bind(function(){this._transitioning=!1,this._current=a,d.resolve()},this)).fail(_.bind(function(){this._transitioning=!1,d.reject()},this));return this.handlers[a].call(this._context,e,f),d.promise()}function f(a,b,c){var d=this.scenes[a],e=this._current,f=b?b:[],g=this._complete=c||_.Deferred(),h=_.Deferred(),i=_.Deferred(),j=_.bind(function(a){this.publish(a,e?e.name:null,d.name)},this),k=_.bind(function(){this._transitioning=!1,g.reject(),j("fail")},this),l=_.bind(function(){this._transitioning=!1,this._current=d,g.resolve(),j("done")},this);if(!d)throw"Scene '"+a+"' not found!";return j("start"),this._transitioning?g.reject():(this._transitioning=!0,e?e.to("exit",f,h).done(function(){d.to("enter",f,i).fail(k)}).fail(k):(h.resolve(),d.to("enter",f,i).fail(k)),_.when(h,i).then(l),g.promise())}function g(a,b){if(!_.isFunction(a))return a;if(/^_/.test(b))return a;if(a.__wrapped)return a;var c=function(b,c){var d=!1,e;return c=c||_.Deferred(),this.async=function(){return d=!0,function(a){return a!==!1?c.resolve():c.reject()}},e=a.apply(this,b),this.async=undefined,d?c.promise():e!==!1?c.resolve():c.reject()};return c.__wrapped=!0,c}var b=a.Miso=a.Miso||{},c=b.Util,d=b.Storyboard=function(a){a=a||{},this._context=a.context||this,this._id=_.uniqueId("scene"),a.scenes?(this._buildScenes(a.scenes),this._initial=a.initial,this.to=f):(this.handlers={},_.each(d.HANDLERS,function(b){a[b]=a[b]||function(){return!0},this.handlers[b]=g(a[b],b)},this),this.to=e),_.each(a,function(a,b){if(_.indexOf(d.BLACKLIST,b)!==-1)return;this[b]=a},this)};d.HANDLERS=["enter","exit"],d.BLACKLIST=["initial","scenes","enter","exit","context"],_.extend(d.prototype,b.Events,{attach:function(a,b){this.name=a,this.parent=b,b._context&&b._context._id!==b._id&&(this._context=b._context,this.scenes&&_.each(this.scenes,function(a,b){a.attach(a.name,this)},this))},start:function(){return typeof this._current!="undefined"?_.Deferred().resolve():this.to(this._initial)},cancelTransition:function(){this._complete.reject(),this._transitioning=!1},scene:function(){return this._current?this._current.name:null},is:function(a){return a===this._current.name},inTransition:function(){return this._transitioning===!0},_buildScenes:function(a){this.scenes={},_.each(a,function(a,c){this.scenes[c]=a instanceof b.Storyboard?a:new b.Storyboard(a),this.scenes[c].attach(c,this)},this)}})}(this,_)