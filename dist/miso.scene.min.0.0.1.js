/**
* Miso.Rig - v0.0.1 - 9/23/2012
* http://github.com/misoproject/rig
* Copyright (c) 2012 Alex Graul, Irene Ros, Rich Harris;
* Dual Licensed: MIT, GPL
* https://github.com/misoproject/scene/blob/master/LICENSE-MIT 
* https://github.com/misoproject/scene/blob/master/LICENSE-GPL 
*/
(function(e,_){var t=e.Miso=e.Miso||{};t.Events={publish:function(e){var t=_.toArray(arguments);t.shift(),this._events&&this._events[e]&&_.each(this._events[e],function(e){e.callback.apply(e.context||this,t)},this)},subscribe:function(e,t,n){n=n||{},this._events=this._events||{},this._events[e]=this._events[e]||[];var r={callback:t,priority:n.priority||0,token:n.token||_.uniqueId("t"),context:n.context||this},i;return _.each(this._events[e],function(e,t){if(!_.isUndefined(i))return;e.priority<=r.priority&&(i=t)}),this._events[e].splice(i,0,r),r.token},subscribeOnce:function(e,t){this._events=this._events||{};var n=_.uniqueId("t");return this.subscribe(e,function(){console.log("unsub"),this.unsubscribe(e,{token:n}),t.apply(this,arguments)},this,n)},unsubscribe:function(e,t){if(_.isUndefined(this._events[e]))return this;_.isFunction(t)?this._events[e]=_.reject(this._events[e],function(e){return e.callback===t}):_.isString(t)?this._events[e]=_.reject(this._events[e],function(e){return e.token===t}):this._events[e]=[]}}})(this,_),function(e,_){function r(e){return function(t,n){var r=!1,i;return this.async=function(){return r=!0,function(e){return e!==!1?t.resolve():t.reject()}},i=e.apply(this,n),this.async=undefined,r?t.promise():i!==!1?t.resolve():t.reject()}}function i(e,t,n){this._transitioning=!0;var r=this._complete=n||_.Deferred(),i=t?t:[],s=_.Deferred().done(_.bind(function(){this._transitioning=!1,this._current=e,r.resolve()},this)).fail(_.bind(function(){this._transitioning=!1,r.reject()},this));return this.handlers[e].call(this._context,s,i),r.promise()}function s(e,t,n){var r=this.children[e],i=this._current,s=t?t:[],o=this._complete=n||_.Deferred(),u=_.Deferred(),a=_.Deferred(),f=_.bind(function(e){this.publish(e,i?i.name:null,r.name)},this),l=_.bind(function(){this._transitioning=!1,o.reject(),f("fail")},this),c=_.bind(function(){this._transitioning=!1,this._current=r,o.resolve(),f("done")},this);if(!r)throw"Scene '"+e+"' not found!";return console.log("pub",f),f("start"),this._transitioning?o.reject():(this._transitioning=!0,i?i.to("exit",s,u).done(function(){r.to("enter",s,a).fail(l)}).fail(l):(u.resolve(),r.to("enter",s,a).fail(l)),_.when(u,a).then(c),o.promise())}var t=e.Miso=e.Miso||{},n=t.Scene=function(e){e=e||{},this._context=e.context||this,this._id=_.uniqueId("scene"),e.children?(this._buildChildren(e.children),this._initial=e.initial,this.to=s):(this.handlers={},_.each(n.HANDLERS,function(t){e[t]=e[t]||function(){return!0},this.handlers[t]=r(e[t])},this),this.to=i),_.each(e,function(e,t){if(_.indexOf(n.BLACKLIST,t)!==-1)return;this[t]=e},this)};n.HANDLERS=["enter","exit"],n.BLACKLIST=["initial","children","enter","exit","context"],_.extend(n.prototype,t.Events,{attach:function(e,t){this.name=e,this.parent=t,t._context&&t._context._id!==t._id&&(this._context=t._context,this.children&&_.each(this.children,function(e,t){e.attach(e.name,this)},this))},start:function(){return this._current?_.Deferred().resolve():this.to(this._initial)},cancelTransition:function(){this._complete.reject(),this._transitioning=!1},scene:function(){return this._current?this._current.name:null},is:function(e){return e===this._current.name},inTransition:function(){return this._transitioning===!0},_buildChildren:function(e){this.children={},_.each(e,function(e,n){this.children[n]=e instanceof t.Scene?e:new t.Scene(e),this.children[n].attach(n,this)},this)}})}(this,_);